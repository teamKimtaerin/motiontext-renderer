# M4: 플러그인 체인 합성 시스템 구현 분석

## 개요

M4 마일스톤에서는 플러그인 체인 합성(Plugin Chain Composition) 시스템을 구현했습니다. 이 시스템은 시간 창(time window) 기반으로 여러 플러그인의 효과를 필터링하고 합성하여, 텍스트 요소에 동적 애니메이션을 적용합니다. 핵심 구현은 `PluginChainComposer`, `Builtin` 플러그인, `StyleApply` 모듈로 구성됩니다.

## 구현 파일 분석

### src/composer/PluginChainComposer.ts

#### 채널 시스템 (Channels)

```typescript
export type Channels = Partial<{
  tx: number;      // translateX in px (relative to overlay pixels)
  ty: number;      // translateY in px
  sx: number;      // scaleX (1 = no change)
  sy: number;      // scaleY
  rot: number;     // rotation in deg
  opacity: number; // 0..1
}>;
```

**목적**: 플러그인이 조작할 수 있는 변환 속성들을 정의
**특징**:
- 모든 필드는 선택적(Partial)로 필요한 속성만 변경
- 픽셀 단위(tx, ty), 배율(sx, sy), 각도(rot), 투명도(opacity) 지원
- 오버레이 좌표계 기준의 상대적 변환

#### 시간 창 평가 (windowEval)

```typescript
export function windowEval(
  absStart: number, 
  absEnd: number, 
  spec: PluginSpec, 
  fps?: number
): PluginEval {
  const { t0, t1 } = computeRelativeWindow(absStart, absEnd, spec, { 
    snapToFrame: false, 
    fps 
  });
  return { spec, t0, t1 };
}
```

**목적**: 플러그인 스펙의 상대적 시간 창을 절대 시간으로 변환
**특징**:
- M2의 `computeRelativeWindow` 활용
- 프레임 스냅 비활성화로 부드러운 애니메이션
- fps 옵션 지원으로 타임코드 기반 제어 가능

#### 진행도 계산 (progress)

```typescript
export function progress(now: number, t0: number, t1: number): number {
  const d = t1 - t0;
  if (!(d > 0)) return 0;
  const p = (now - t0) / d;
  if (p < 0) return 0; 
  if (p > 1) return 1; 
  return p;
}
```

**목적**: 현재 시간의 애니메이션 진행도(0~1) 계산
**특징**:
- 0~1 범위로 클램핑
- 역방향 시간창(t1 < t0) 방어 처리
- 선형 보간 기반

#### 채널 합성 (composeChannels)

```typescript
export function composeChannels(
  acc: Channels, 
  add: Channels, 
  mode: ComposeMode | undefined
): Channels {
  const out: Channels = { ...acc };
  for (const k of Object.keys(add) as (keyof Channels)[]) {
    const v = add[k]!;
    if (mode === "add") 
      out[k] = ((out[k] as number | undefined) ?? 0) + (v as number);
    else if (mode === "multiply") 
      out[k] = ((out[k] as number | undefined) ?? 1) * (v as number);
    else 
      out[k] = v; // replace (last wins)
  }
  return out;
}
```

**목적**: 두 채널을 합성 모드에 따라 결합
**합성 모드**:
- **replace** (기본): 새 값으로 덮어쓰기 (last-wins)
- **add**: 누적 덧셈 (기본값 0)
- **multiply**: 누적 곱셈 (기본값 1)

**설계 원칙**:
- 각 채널 속성별로 독립적 합성
- 기본값이 합성 모드에 맞게 설정 (add=0, multiply=1)
- 명시적 모드 지정 없으면 replace로 동작

#### 활성 플러그인 합성 (composeActive)

```typescript
export function composeActive(
  chain: PluginChain | undefined,
  now: number,
  absStart: number,
  absEnd: number,
  evalFn: (_spec: PluginSpec, _p: number) => Channels,
  fps?: number
): Channels {
  if (!chain || chain.length === 0) return {};
  let acc: Channels = {};
  for (const spec of chain) {
    const { t0, t1 } = computeRelativeWindow(absStart, absEnd, spec, { fps });
    if (!isWithin(now, t0, t1)) continue;
    const p = progress(now, t0, t1);
    const ch = evalFn(spec, p);
    acc = composeChannels(acc, ch, spec.compose);
  }
  return acc;
}
```

**목적**: 플러그인 체인 전체를 순회하며 활성 플러그인들의 효과 합성
**핵심 로직**:
1. 각 플러그인의 시간 창 계산
2. 현재 시간이 창 내에 있는지 확인 (활성 필터링)
3. 진행도 계산 후 플러그인 평가
4. 합성 모드에 따라 누적

**특징**:
- 순차적 처리로 last-wins 보장
- 비활성 플러그인은 건너뛰어 성능 최적화
- evalFn 주입으로 플러그인 구현체 분리

### src/runtime/plugins/Builtin.ts

#### 이징 함수들

```typescript
const clamp01 = (x: number) => x < 0 ? 0 : x > 1 ? 1 : x;
const easeOutCubic = (t: number) => 1 - Math.pow(1 - t, 3);
const backOut = (t: number, s = 1.70158) => {
  const x = t - 1;
  return (x * x * ((s + 1) * x + s) + 1);
};
```

**목적**: 자연스러운 애니메이션을 위한 이징 곡선
**종류**:
- `clamp01`: 0~1 범위 제한
- `easeOutCubic`: 끝에서 감속하는 3차 곡선
- `backOut`: 오버슈트 후 돌아오는 효과

#### 내장 플러그인 평가 (evalBuiltin)

```typescript
export function evalBuiltin(spec: PluginSpec, p: number): Channels {
  const name = spec.name;
  const params = spec.params ?? {};
  switch (name) {
    case "fadeIn": {
      const o = clamp01(easeOutCubic(p));
      return { opacity: o };
    }
    case "fadeOut": {
      const o = 1 - clamp01(p);
      return { opacity: o };
    }
    case "pop": {
      const max = typeof params.maxScale === "number" ? params.maxScale : 1.2;
      const s = 1 + (max - 1) * backOut(p, 1.7);
      return { sx: s, sy: s };
    }
    case "waveY": {
      const amp = typeof params.amplitudePx === "number" ? params.amplitudePx : 8;
      const freq = typeof params.frequency === "number" ? params.frequency : 2;
      const ty = Math.sin(p * Math.PI * 2 * freq) * amp;
      return { ty };
    }
    case "shakeX": {
      const amp = typeof params.amplitudePx === "number" ? params.amplitudePx : 6;
      const cycles = typeof params.cycles === "number" ? params.cycles : 8;
      const f = Math.sin(p * Math.PI * 2 * cycles);
      return { tx: f * amp };
    }
    default:
      return {};
  }
}
```

**내장 플러그인 목록**:

1. **fadeIn**: 서서히 나타나기
   - easeOutCubic 이징으로 부드러운 페이드
   - opacity: 0 → 1

2. **fadeOut**: 서서히 사라지기
   - 선형 감소
   - opacity: 1 → 0

3. **pop**: 팝 애니메이션
   - backOut 이징으로 오버슈트 효과
   - maxScale 파라미터 (기본 1.2)
   - sx, sy 동시 적용으로 균일한 확대

4. **waveY**: 수직 파동
   - 사인파 기반 상하 움직임
   - amplitudePx: 진폭 (기본 8px)
   - frequency: 진동 횟수 (기본 2회)

5. **shakeX**: 수평 흔들림
   - 사인파 기반 좌우 움직임
   - amplitudePx: 진폭 (기본 6px)
   - cycles: 흔들림 횟수 (기본 8회)

**설계 특징**:
- 파라미터 타입 안전성 검증
- 기본값 제공으로 사용성 향상
- 진행도 p(0~1)를 기반으로 한 시간 독립적 애니메이션

### src/runtime/StyleApply.ts

#### 변환 문자열 생성 (buildTransform)

```typescript
export function buildTransform(base: string | undefined, ch: Channels): string {
  const parts: string[] = [];
  if (base && base.length) parts.push(base);
  const sx = ch.sx ?? 1;
  const sy = ch.sy ?? 1;
  if (sx !== 1 || sy !== 1) parts.push(`scale(${sx}, ${sy})`);
  const tx = ch.tx ?? 0;
  const ty = ch.ty ?? 0;
  if (tx !== 0 || ty !== 0) 
    parts.push(`translate(${Math.round(tx * 100) / 100}px, ${Math.round(ty * 100) / 100}px)`);
  const rot = ch.rot ?? 0;
  if (rot !== 0) parts.push(`rotate(${rot}deg)`);
  return parts.join(" ");
}
```

**목적**: 채널 값을 CSS transform 문자열로 변환
**변환 순서**:
1. 기본 변환 (base) 유지
2. scale 적용
3. translate 적용 (소수점 2자리 반올림)
4. rotate 적용

**최적화**:
- 기본값과 같으면 변환 생략
- 픽셀 값 반올림으로 렌더링 성능 향상

#### 채널 적용 (applyChannels)

```typescript
export function applyChannels(
  el: HTMLElement, 
  baseTransform: string | undefined, 
  ch: Channels
) {
  el.style.transform = buildTransform(baseTransform, ch);
  if (ch.opacity != null) el.style.opacity = String(ch.opacity);
}
```

**목적**: 합성된 채널을 DOM 요소에 실제 적용
**특징**:
- transform과 opacity 분리 처리
- 기본 변환 보존하며 추가 변환 적용
- null 체크로 불필요한 스타일 변경 방지

## 통합 사용 예시 (src/index.ts)

```typescript
const chain = (node as any).pluginChain as any[] | undefined;
const ch: Channels = composeActive(
  chain as any, 
  t,           // 현재 시간
  t0,          // 노드의 absStart
  t1,          // 노드의 absEnd
  (spec, p) => evalBuiltin(spec, p)
);
applyChannels(el, baseT, ch);
```

**플로우**:
1. 노드에서 pluginChain 추출
2. composeActive로 현재 시간의 활성 플러그인 합성
3. evalBuiltin으로 각 플러그인 평가
4. applyChannels로 DOM에 적용

## 설계 원칙

### 1. 시간 창 기반 활성화
- 플러그인은 자체 시간 창 내에서만 활성
- relStart/relEnd 또는 relStartPct/relEndPct로 유연한 시간 지정
- 요소 생명주기와 독립적인 플러그인 타이밍

### 2. 합성 모드
- **replace**: 단순 덮어쓰기 (기본)
- **add**: 효과 누적 (예: 여러 translate 합산)
- **multiply**: 효과 배수 (예: 여러 scale 곱셈)
- last-wins 원칙으로 예측 가능한 결과

### 3. 채널 추상화
- 변환 속성을 채널로 추상화
- 각 채널은 독립적으로 합성
- DOM 구현과 분리된 순수 함수형 설계

### 4. 성능 최적화
- 비활성 플러그인 조기 필터링
- 기본값 변환 생략
- 픽셀 값 반올림으로 리플로우 최소화

## 확장성 고려사항

### 1. 새로운 내장 플러그인 추가
`evalBuiltin`에 새 case 추가로 간단히 확장

### 2. 외부 플러그인 지원
evalFn을 교체하여 동적 로딩 플러그인 평가 가능

### 3. 새로운 채널 추가
Channels 타입 확장과 StyleApply 수정으로 새 속성 지원

### 4. 고급 합성 모드
composeChannels 확장으로 screen, overlay 등 추가 모드 구현 가능

## 검증 포인트

### 시간 창 겹침 처리
- 겹치지 않는 플러그인: 독립적 적용
- 겹치는 플러그인 + compose 미지정: 뒤 플러그인이 앞 플러그인 덮어쓰기
- 겹치는 플러그인 + compose:"add": 효과 누적
- 겹치는 플러그인 + compose:"multiply": 효과 곱셈

### 애니메이션 품질
- 이징 함수로 자연스러운 움직임
- 60fps에서 부드러운 재생
- 시킹 시 즉시 올바른 상태로 점프

이 플러그인 시스템은 M5(레이아웃), M6(에셋), M8(동적 로딩)과 연계하여 풍부한 애니메이션 효과를 제공하는 핵심 기반입니다.

## 테스트 케이스 분석

### PluginChainComposer 테스트 (22개)

#### windowEval 테스트 (3개)

##### 1. 상대 오프셋 시간 창 계산
**의미**: relStart/relEnd를 사용한 플러그인 시간 창 계산
**검증 내용**: relStart=0.5, relEnd=-0.5일 때 [10.5, 19.5] 반환

##### 2. 퍼센트 오프셋 시간 창 계산
**의미**: relStartPct/relEndPct를 사용한 비율 기반 시간 창 계산
**검증 내용**: relStartPct=0.2, relEndPct=0.1일 때 올바른 계산 및 클램핑

##### 3. fps 파라미터 처리
**의미**: 프레임 스냅 옵션이 꺼진 상태 확인
**검증 내용**: snapToFrame=false이므로 원본 값 유지

#### progress 테스트 (4개)

##### 4. 시간 창 내 진행도 계산
**의미**: 현재 시간의 0~1 진행도 정확한 계산
**검증 내용**: 중간점에서 0.5, 1/4 지점에서 0.25 등

##### 5. 진행도 0-1 범위 클램핑
**의미**: 시간 창 밖의 값도 안전하게 처리
**검증 내용**: 음수는 0, 1 초과는 1로 제한

##### 6. 제로 기간 창 처리
**의미**: 시작과 끝이 같은 경우 처리
**검증 내용**: 항상 진행도 0 반환

##### 7. 역전된 시간 창 처리
**의미**: t1 < t0인 비정상 케이스 방어
**검증 내용**: 안전하게 0 반환

#### composeChannels 테스트 (6개)

##### 8. 기본 replace 모드
**의미**: 합성 모드 미지정시 덮어쓰기 동작
**검증 내용**: 새 값이 기존 값을 완전히 대체

##### 9. add 모드 합성
**의미**: 채널 값 누적 덧셈
**검증 내용**: tx: 10+5=15, ty: 20+(-10)=10

##### 10. multiply 모드 합성
**의미**: 채널 값 누적 곱셈
**검증 내용**: sx: 2*1.5=3, opacity: 0.5*0.8=0.4

##### 11. add 모드 기본값
**의미**: 누적 시작값이 0인지 확인
**검증 내용**: undefined → 0으로 처리 후 덧셈

##### 12. multiply 모드 기본값
**의미**: 누적 시작값이 1인지 확인
**검증 내용**: undefined → 1로 처리 후 곱셈

##### 13. 비중첩 채널 보존
**의미**: 영향 없는 채널은 그대로 유지
**검증 내용**: tx 변경시 rot은 그대로 유지

#### composeActive 테스트 (9개)

##### 14. 빈 체인 처리
**의미**: 플러그인 없을 때 안전한 처리
**검증 내용**: undefined나 빈 배열은 {} 반환

##### 15. 비활성 플러그인 필터링
**의미**: 시간 창 밖 플러그인 제외
**검증 내용**: t=2에서 [0,5] 플러그인만 활성, [5,10] 플러그인은 무시

##### 16. replace 모드로 중첩 합성
**의미**: last-wins 정책 동작 확인
**검증 내용**: fade와 move 중첩시 move가 없는 채널은 fade 값 유지

##### 17. add 모드로 중첩 합성
**의미**: 효과 누적 동작
**검증 내용**: 두 move 플러그인의 tx/ty 값 합산

##### 18. multiply 모드로 중첩 합성
**의미**: 효과 배수 동작
**검증 내용**: 두 scale 플러그인의 sx/sy 값 곱셈

##### 19. 혼합 모드 체인 처리
**의미**: 여러 합성 모드 순차 적용
**검증 내용**: replace → add → replace 순서대로 정확히 적용

##### 20. 플러그인 시간 창 준수
**의미**: relStartPct/relEndPct 기반 활성화
**검증 내용**: 창 전/중/후 상태 전환 정확성

##### 21. 경계값 처리
**의미**: 시작점(포함)/끝점(제외) 처리
**검증 내용**: t0에서 활성, t1에서 비활성

##### 22. fps 파라미터 전달
**의미**: fps 옵션이 하위 함수에 전달
**검증 내용**: 정밀한 시간값 그대로 처리

### Builtin 플러그인 테스트 (19개)

#### fadeIn/fadeOut 테스트 (4개)

##### 23-24. fadeIn 이징 곡선
**의미**: easeOutCubic으로 자연스러운 페이드인
**검증 내용**: 0→1 변화, 중간값이 선형보다 큼

##### 25-26. fadeOut 선형 감소
**의미**: 일정한 속도로 페이드아웃
**검증 내용**: 1→0 선형 변화

#### pop 테스트 (4개)

##### 27. backOut 이징 스케일
**의미**: 오버슈트 효과의 팝 애니메이션
**검증 내용**: 1→1.2 변화, 80% 지점에서 살짝 오버슈트

##### 28. 커스텀 maxScale
**의미**: 파라미터로 최대 크기 조절
**검증 내용**: maxScale=2.0 정확히 적용

##### 29. 잘못된 파라미터 처리
**의미**: 타입 오류시 기본값 사용
**검증 내용**: 문자열 입력시 기본 1.2 사용

##### 30. 균일 스케일링
**의미**: sx와 sy 항상 동일
**검증 내용**: 모든 시점에서 sx === sy

#### waveY 테스트 (4개)

##### 31. 사인파 움직임
**의미**: 주기적인 상하 운동
**검증 내용**: sin 함수 기반 정확한 위치

##### 32. 커스텀 진폭
**의미**: amplitudePx로 움직임 크기 조절
**검증 내용**: 20px 진폭 정확히 적용

##### 33. 커스텀 주파수
**의미**: frequency로 진동 횟수 조절
**검증 내용**: 1회 진동시 정확한 주기

##### 34. 파라미터 오류 처리
**의미**: 잘못된 타입시 기본값 사용
**검증 내용**: 기본 amp=8, freq=2 적용

#### shakeX 테스트 (4개)

##### 35. 수평 흔들림 움직임
**의미**: 좌우 빠른 진동
**검증 내용**: 양수/음수 tx 값 교대 출현

##### 36. 커스텀 진폭
**의미**: 흔들림 강도 조절
**검증 내용**: 15px 진폭 적용

##### 37. 커스텀 사이클
**의미**: 흔들림 횟수 조절
**검증 내용**: 2사이클시 정확한 주기

##### 38. 파라미터 오류 처리
**의미**: 기본값으로 안전한 폴백
**검증 내용**: amp=6, cycles=8 기본값

#### 기타 테스트 (3개)

##### 39. 미지원 플러그인
**의미**: 알 수 없는 플러그인명 처리
**검증 내용**: 빈 채널 {} 반환

##### 40-41. 파라미터 검증
**의미**: params 객체 없거나 비어있을 때
**검증 내용**: 모든 플러그인이 기본값으로 정상 동작

### StyleApply 테스트 (13개)

#### buildTransform 테스트 (13개)

##### 42. 빈 변환 처리
**의미**: 변환 없을 때 빈 문자열
**검증 내용**: undefined/{} → ""

##### 43. 기본 변환 유지
**의미**: base transform 보존
**검증 내용**: "translateZ(0)" 그대로 유지

##### 44. scale 변환 적용
**의미**: sx, sy를 CSS scale()로
**검증 내용**: "scale(2, 3)" 생성

##### 45. scale 1 생략
**의미**: 불필요한 변환 제거
**검증 내용**: sx=1, sy=1일 때 빈 문자열

##### 46. translate 반올림
**의미**: 픽셀값 소수점 2자리 반올림
**검증 내용**: 10.567 → 10.57px

##### 47. translate 0 생략
**의미**: 불필요한 이동 제거
**검증 내용**: tx=0, ty=0일 때 빈 문자열

##### 48. rotate 변환
**의미**: 회전 각도 적용
**검증 내용**: "rotate(45deg)" 생성

##### 49. rotate 0 생략
**의미**: 불필요한 회전 제거
**검증 내용**: rot=0일 때 빈 문자열

##### 50. 다중 변환 순서
**의미**: scale → translate → rotate 순서
**검증 내용**: 올바른 순서로 조합

##### 51. base와 새 변환 결합
**의미**: 기존 변환 뒤에 추가
**검증 내용**: "perspective(100px) scale(1.5, 1.5) rotate(30deg)"

##### 52. 부분 채널 처리
**의미**: undefined 값 기본값 사용
**검증 내용**: sx만 있으면 sy=1 사용

##### 53. 반올림 경계값
**의미**: 0.005 반올림 처리
**검증 내용**: 0.004→0, 0.005→0.01

##### 54. 음수값 처리
**의미**: 음수 변환값 정확히 처리
**검증 내용**: 모든 음수값 올바른 출력

## 요약

M4 플러그인 체인 합성 시스템은 54개의 포괄적인 테스트를 통해 다음을 검증합니다:
- 시간 창 계산과 진행도 관리
- 세 가지 합성 모드(replace, add, multiply)의 정확한 동작
- 활성 플러그인 필터링과 순차 합성
- 5개 내장 플러그인의 애니메이션 품질
- CSS transform 문자열 생성과 최적화
- 오류 처리와 기본값 폴백
- 성능 최적화(불필요한 변환 생략)